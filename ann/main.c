/*******************************************************************************
 * Copyright (C) 2016 Maxim Integrated Products, Inc., All Rights Reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a
 * copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
 * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 * IN NO EVENT SHALL MAXIM INTEGRATED BE LIABLE FOR ANY CLAIM, DAMAGES
 * OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 *
 * Except as contained in this notice, the name of Maxim Integrated
 * Products, Inc. shall not be used except as stated in the Maxim Integrated
 * Products, Inc. Branding Policy.
 *
 * The mere transfer of this software does not imply any licenses
 * of trade secrets, proprietary technology, copyrights, patents,
 * trademarks, maskwork rights, or any other form of intellectual
 * property whatsoever. Maxim Integrated Products, Inc. retains all
 * ownership rights.
 *
 * $Date: 2018-09-05 16:46:11 -0500 (Wed, 05 Sep 2018) $
 * $Revision: 37695 $
 *
 ******************************************************************************/

/**
 * @file    main.c
 * @brief   Hello World!
 * @details This example uses the UART to print to a terminal and flashes an LED.
 */

/***** Includes *****/
#include <stdio.h>
#include <stdint.h>
#include "mxc_device.h"
#include "led.h"
#include "board.h"
#include "mxc_delay.h"


#include <math.h>
#include <stdlib.h>
#include "ann.h"
#include "input.h"



/***** Definitions *****/

/***** Globals *****/

/***** Functions *****/

// *****************************************************************************
int main(void)
{

	//Variables used, and alloc ANN network
	int NUM_TEST = 1000;
	network *ann = (network*)malloc(sizeof(network));
	int dim[3] = {11,32,16}; //Dimension array
	printf("dim[0] = %d \n",dim[0]);
	int weights[LAYER_SIZE][MAX_SIZE][MAX_SIZE];
	int biases[LAYER_SIZE][MAX_SIZE];
	double output[LAYER_SIZE][MAX_SIZE];
	int n_layers = 3;
	//double input0[11] = {1,1,1,1,1,1,1,1,1,1,1};

	//double input0[11] = {0.75294118, 0.65882353, 0.00392157, 0.77254902, 0.58548867, 0.61176471,
	  // 0.00392157, 0.48235294, 0.20784314, 0.5678645,  0};
	printf("Starting!\n");
	int loop_count = 0;
	// Layer1 parameter
	int weights0_temp[352] = {0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
			0xfffffb1b,0x00004583,0x00006a59,0xffffe2bd,0x00000240,0xfffee70d,0x00000355,0xfffff2f8,0x000016a4,0x0000109e,0x00001cac,
			 0xffffc4d0,0x00004103,0xffffa48f,0xffffce8d,0xffff9d77,0xffffdebc,0xfffffc22,0x00007a26,0xffffca1f,0x00002501,0x00002cb5,
			 0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
			 0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
			 0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
			 0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
			 0xffffe8ba,0xffff7add,0x00001d0e,0x0000fa27,0xffff82b3,0xffff7f43,0xffffff52,0x000016e8,0xffffdd44,0xffffcd99,0xffffd411,
			 0x0000013f,0x00015c70,0x0000013b,0xffffffd5,0x00000198,0xfffff984,0x0001f44f,0xffff41cf,0x0000aa96,0xffff5959,0xffff38aa,
			 0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
			 0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
			 0x000069c4,0x00005723,0x00000075,0xfffffede,0x0000016f,0xfffffe6e,0xfffeb117,0x0000578f,0x00004e30,0x00004200,0x0000502c,
			 0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
			 0xffff457c,0x0000cbcb,0x00000076,0x0000009a,0x000000c8,0xfffffe2b,0xfffde3e7,0x0000fe90,0xffff4c4a,0x00005fcf,0x000068fc,
			 0xffff6701,0xffff7468,0xffff8e1f,0xffff8d52,0x0000c007,0x00001051,0xffffff27,0x000039d8,0x00002675,0x00000580,0x000004ae,
			 0xffff88bf,0xffff3063,0x0000eea8,0xffffa14e,0x0000812c,0xffffd646,0xfffffe00,0x00000968,0xffffe525,0xffffc9e8,0xffffc629,
			 0xfffff436,0x0000535c,0xffff1a66,0x00001ff3,0xffffdcb2,0x00005894,0xfffffce9,0x0000103e,0xffffe090,0xfffff4d3,0xffffefc6,
			 0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
			 0xffffa57e,0xffffedf5,0xffff6eb1,0x000097b9,0x0000a057,0xffff7c85,0xfffffffd,0x0000bab8,0xffff2949,0xffffa7b1,0xffffa358,
			 0x00004058,0xfffedda4,0xfffffc9f,0x00000586,0xffffff85,0x00000664,0x00000391,0x000040c5,0x000022fd,0x00004a7e,0x00004cee,
			 0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
			 0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
			 0xffffaccc,0xfffff3d4,0xffffffb8,0xffffffb0,0xffffffc5,0xfffffee4,0xfffffedc,0xfff92405,0xffffe9c0,0x0003707d,0x00040000,
			 0xffffe22a,0x0000ce9c,0x000017e9,0xffffbda4,0x00002875,0x00000aee,0xffff6078,0xffff93fc,0x000046e0,0x00000928,0x00000e5f,
			 0x000090dc,0xffff5447,0x00009361,0xffff6dc8,0xffff4f7d,0x00007ca4,0xfffffdb5,0x00003660,0x000004b3,0xffffe938,0xffffd389,
			 0x000020f8,0xffff692b,0xfffff34e,0x00008fff,0xfffff6f4,0x00002e93,0x0000299a,0xffffbc1f,0xfffff70a,0xffffdbb7,0xffffce06,
			 0xfffff560,0x0001bbdf,0xfffff7a9,0xffffff2a,0xfffffec7,0xfffffddc,0xffffe5c3,0xffff8f7a,0xffff9ae5,0xffffa1bb,0xffff8d2c,
			 0xffffd10a,0x0000a893,0x000008a2,0xfffff1d5,0xffffec65,0x00001e11,0x000129fa,0x0000f2da,0xfffe998a,0xffff71d0,0xffff418c,
			 0x000067f4,0x00001ac8,0x00002c62,0x00000f3b,0x000037b6,0xfffee9be,0x00002458,0x00001206,0x00000df2,0x0000325d,0x00002d19,
			 0x0000141b,0x00002d2a,0xfffffc46,0xffffffa9,0x000002e9,0xfffffce9,0x0000078f,0xfffa17cc,0xffffb617,0x0002f246,0x00034c70,
			 0xfffffbdb,0x00019a64,0x00000012,0x0000003c,0xfffffffc,0x00000024,0x000283d0,0xfffe5ae4,0x000050c3,0xffffbf20,0xffffad38,
			 0x000002b0,0xffffd4a9,0x0000000b,0xffffff35,0x0000011b,0xfffffe81,0xffff093e,0xfffd8d45,0x000053aa,0x0001ea7f,0x0002141d};


//	int factorA0 = 0x0444eb90;
	//Layer 2 parameters
	int weights1_temp[512] = {0x0001578e,0x000114cf,0x00035311,0xffffd117,0xffff5c3d,0xfffff173,0xffffda8c,0x00003a08,0xffffb384,0xfffc651b,0x00000000,0x00000000,0x0000513b,0x00002b39,0x00000000,0xffffbeff,0x00002dcb,0x00002f85,0xfffef996,0x00000000,0x000063ae,0x00000000,0x00000000,0xffff375a,0x00003cc9,0x00000000,0x00000000,0x00000000,0x00000000,0x00002975,0x000040f7,0x00000000,
			0xfffffa14,0xfffffc64,0xffffffd0,0xfffffdf1,0xfffff303,0xfffffffb,0xfffffe48,0xffffff0e,0xfffffffb,0xffffff83,0x00000000,0x00000000,0xfffff364,0xfffffe77,0x00000000,0xffffff83,0xfffffddc,0xfffffe72,0xfffffe5f,0x00000000,0xffffffbe,0x00000000,0x00000000,0xffffff71,0xfffffec6,0x00000000,0x00000000,0x00000000,0x00000000,0xfffffd53,0xffffffd8,0x00000000,
			0x0000051a,0x00001087,0xfffffc6f,0xffffe1ea,0xfffff262,0xfffff913,0x00001b2e,0x00000326,0xfffffc0a,0x00001a26,0x00000000,0x00000000,0xfffffa39,0x0000153f,0x00000000,0xfffff2b5,0x0000385a,0x00003863,0xffffe66a,0x00000000,0xffffeb54,0x00000000,0x00000000,0xffffd36f,0x0000273d,0x00000000,0x00000000,0x00000000,0x00000000,0x00000efc,0xfffffa6d,0x00000000,
			0xfffff8c3,0xffffff14,0xffffffcb,0x00000207,0xfffff4bb,0xfffffff9,0xffffff25,0xfffffee0,0xfffffffa,0xffffff68,0x00000000,0x00000000,0xfffff462,0x00000204,0x00000000,0xffffff68,0xfffffd8b,0xfffffe0d,0xfffffe2f,0x00000000,0xffffffba,0x00000000,0x00000000,0xfffffffd,0x000003c2,0x00000000,0x00000000,0x00000000,0x00000000,0xfffffca5,0xffffffcb,0x00000000,
			0xfffe958a,0xfffea4cc,0xfffc7140,0xffffec34,0x0000d367,0x00007751,0xffffde32,0x000018e2,0x00000e1a,0x00040000,0x00000000,0x00000000,0x00005023,0x00004e4b,0x00000000,0xffffbc7c,0x00002f3c,0x000037e2,0x00010381,0x00000000,0xffff63d1,0x00000000,0x00000000,0x000141aa,0x00003ac1,0x00000000,0x00000000,0x00000000,0x00000000,0x0000248f,0x00004987,0x00000000,
			0xfffff730,0x00001be8,0xfffff02c,0xffffb7e5,0xffffdd4f,0x00004577,0xffffdaad,0x00006394,0xffffbdd9,0x00001703,0x00000000,0x00000000,0x0000159c,0x000037c4,0x00000000,0x00004a95,0x00000c5c,0xffffd10a,0x0000159e,0x00000000,0xffffe29b,0x00000000,0x00000000,0x00000c4f,0xffffedd9,0x00000000,0x00000000,0x00000000,0x00000000,0x000001ae,0xffffe413,0x00000000,
			0x00005e47,0x00004005,0x00004e00,0x0000a49e,0xffffd355,0x00008248,0x00006686,0xffff3df0,0x0000a091,0xffff692f,0x00000000,0x00000000,0x000065b7,0xffff1207,0x00000000,0x0000639c,0xffff311d,0xffff5df5,0xffffcd05,0x00000000,0x00006541,0x00000000,0x00000000,0xfffff4fa,0xffff5b87,0x00000000,0x00000000,0x00000000,0x00000000,0xffffa453,0xffff6b34,0x00000000,
			0xffffc3c7,0xfffff7d5,0x0000203e,0xfffff151,0x00001121,0xffffe42a,0xfffffcfb,0xfffff972,0xfffff0be,0x00001fe7,0x00000000,0x00000000,0x000005d0,0x0000085e,0x00000000,0xfffff755,0x000025cd,0x00001904,0xfffffa4f,0x00000000,0xfffffac9,0x00000000,0x00000000,0xffffe8e8,0x00000140,0x00000000,0x00000000,0x00000000,0x00000000,0xfffff88b,0x00000535,0x00000000,
			0x00003687,0x00000f11,0x0000006f,0x00000b72,0x0000763e,0xffff01c0,0xfffff388,0x000008b6,0xfffff6fe,0x000007e4,0x00000000,0x00000000,0xffff45c5,0x00002982,0x00000000,0xffffe9ef,0x00000a1e,0x000014e4,0x00004d5a,0x00000000,0x000013c4,0x00000000,0x00000000,0xffffceac,0x00000d15,0x00000000,0x00000000,0x00000000,0x00000000,0x000014f4,0x0000207e,0x00000000,
			0xfffffa14,0xfffffc64,0xffffffd0,0xfffffdf1,0xfffff303,0xfffffffb,0xfffffe48,0xffffff0e,0xfffffffb,0xffffff83,0x00000000,0x00000000,0xfffff364,0xfffffe77,0x00000000,0xffffff83,0xfffffddc,0xfffffe72,0xfffffe5f,0x00000000,0xffffffbe,0x00000000,0x00000000,0xffffff71,0xfffffec6,0x00000000,0x00000000,0x00000000,0x00000000,0xfffffd53,0xffffffd8,0x00000000,
			0xfffffa40,0xfffffc75,0xffffffd0,0xfffffdec,0xfffff3b7,0xfffffffb,0xfffffe51,0xffffff20,0xfffffffb,0xffffff81,0x00000000,0x00000000,0xfffff3e9,0xfffffe6f,0x00000000,0xffffff80,0xfffffe1d,0xfffffe6a,0xfffffe5b,0x00000000,0xffffffbd,0x00000000,0x00000000,0xffffff6e,0xfffffed0,0x00000000,0x00000000,0x00000000,0x00000000,0xfffffd45,0xffffffd7,0x00000000,
			0xfffffff5,0xfffff67c,0xffffffae,0xfffff915,0xfffffade,0xfffffffc,0x00000051,0x00000638,0xfffffffc,0xfffffea5,0x00000000,0x00000000,0xfffffbf7,0xfffffb2e,0x00000000,0xfffffea4,0x00000acc,0xfffffaf9,0xfffffb32,0x00000000,0xffffff40,0x00000000,0x00000000,0xfffffe69,0x000002bc,0x00000000,0x00000000,0x00000000,0x00000000,0xfffff81e,0xffffff74,0x00000000,
			0xfffffa14,0xfffffc64,0xffffffd0,0xfffffdf1,0xfffff303,0xfffffffb,0xfffffe48,0xffffff0e,0xfffffffb,0xffffff83,0x00000000,0x00000000,0xfffff364,0xfffffe77,0x00000000,0xffffff83,0xfffffddc,0xfffffe72,0xfffffe5f,0x00000000,0xffffffbe,0x00000000,0x00000000,0xffffff71,0xfffffec6,0x00000000,0x00000000,0x00000000,0x00000000,0xfffffd53,0xffffffd8,0x00000000,
			0xfffffa14,0xfffffc64,0xffffffd0,0xfffffdf1,0xfffff303,0xfffffffb,0xfffffe48,0xffffff0e,0xfffffffb,0xffffff83,0x00000000,0x00000000,0xfffff364,0xfffffe77,0x00000000,0xffffff83,0xfffffddc,0xfffffe72,0xfffffe5f,0x00000000,0xffffffbe,0x00000000,0x00000000,0xffffff71,0xfffffec6,0x00000000,0x00000000,0x00000000,0x00000000,0xfffffd53,0xffffffd8,0x00000000,
			0xfffffa14,0xfffffc64,0xffffffd0,0xfffffdf1,0xfffff303,0xfffffffb,0xfffffe48,0xffffff0e,0xfffffffb,0xffffff83,0x00000000,0x00000000,0xfffff364,0xfffffe77,0x00000000,0xffffff83,0xfffffddc,0xfffffe72,0xfffffe5f,0x00000000,0xffffffbe,0x00000000,0x00000000,0xffffff71,0xfffffec6,0x00000000,0x00000000,0x00000000,0x00000000,0xfffffd53,0xffffffd8,0x00000000,
			0xfffffa14,0xfffffc64,0xffffffd0,0xfffffdf1,0xfffff303,0xfffffffb,0xfffffe48,0xffffff0e,0xfffffffb,0xffffff83,0x00000000,0x00000000,0xfffff364,0xfffffe77,0x00000000,0xffffff83,0xfffffddc,0xfffffe72,0xfffffe5f,0x00000000,0xffffffbe,0x00000000,0x00000000,0xffffff71,0xfffffec6,0x00000000,0x00000000,0x00000000,0x00000000,0xfffffd53,0xffffffd8,0x00000000};

//	int factorA1 = 0x0644d6a8;

	// Load weights
	printf("Init Weights \n");
	for(int i=1;i<n_layers;i++){
		for(int j=0;j<dim[i];j++){
			for(int k=0;k<dim[i-1];k++){
				if(i==1){
					weights[i-1][j][k] =  weights0_temp[j*dim[i-1]+k];
					printf("weights0_temp[%d] = %d ", j*dim[i-1]+k ,weights0_temp[j*dim[i-1]+k]);
					printf("weights[%d][%d][%d] = %d \n", i-1,j,k,weights[i-1][j][k]);
				}
				if(i==2){
					weights[i-1][j][k]=  weights1_temp[j*dim[i-1]+k];
					printf("weights1_temp[%d] = %d ", j*dim[i-1]+k ,weights1_temp[j*dim[i-1]+k]);
					printf("weights[%d][%d][%d] = %d \n", i-1,j,k,weights[i-1][j][k]);
				}

			}
		}
	}

	//Init Biases, this ANN dose not use biases
	for(int i=0;i<n_layers;i++){
		for(int j=0;j<dim[i];j++){
			if(i == 0){
				biases[i][j] = 0;
			}
			else{
				biases[i][j] = 0;
			}
		}
	}

	//Init ANN with pre-trained weights
	printf("Assigning parameters\n");
	init_ann_with_weights(ann,dim,weights,biases,n_layers);
	printf("Inference\n");

	int label = 0, max_index = 0;
	int correct_count = 0;
	double max_temp = 0;
	//Loop through all input data
	while(loop_count<NUM_TEST){

		//printf("Init inputs \n");
		for(int j=0;j<LAYER_SIZE;j++){
			label = inputs[loop_count][0];
			for(int k=0;k<MAX_SIZE;k++){
				if(j==0 && k < 11){
					output[j][k] = inputs[loop_count][k+1];// index 0 is label
				}
				else output[j][k] = 0;
			}
		}


		//Calculate output
		feed_forward(ann,output);

		// Find max index
		max_temp = output[2][0];
		max_index = 0;
		for(int k=1;k<16;k++){
			if(output[2][k] > max_temp){
				max_index = k;
				max_temp = output[2][k];
			}
		}
		//Update the correct count value
		if(max_index==label){
			correct_count++;
			//printf("Run number %d is corrected!\n", loop_count);
		}


//Print output array:
//	    for(int j=0;j<LAYER_SIZE;j++){
//			for(int k=0;k<MAX_SIZE;k++){
//				printf("output[%d][%d] = %f \n",j,k,output[j][k]);
//			}
//		}

	    loop_count++;
	}

	printf("Done\n");
	printf("Run total %d inputs, correct: %d \n",NUM_TEST,correct_count);
    
}
